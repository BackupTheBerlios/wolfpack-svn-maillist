<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Wolfpack-svn] r6841 - in trunk/server/release: definitions	definitions/items/armory/samurai	definitions/items/weaponry/samurai scripts scripts/potions	scripts/skills scripts/wolfpack
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/wolfpack-svn/2007-June/index.html" >
   <LINK REL="made" HREF="mailto:wolfpack-svn%40lists.berlios.de?Subject=Re%3A%20%5BWolfpack-svn%5D%20r6841%20-%20in%20trunk/server/release%3A%20definitions%0A%09definitions/items/armory/samurai%0A%09definitions/items/weaponry/samurai%20scripts%20scripts/potions%0A%09scripts/skills%20scripts/wolfpack&In-Reply-To=%3C200706251334.l5PDYx2W028280%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000045.html">
   <LINK REL="Next"  HREF="000047.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Wolfpack-svn] r6841 - in trunk/server/release: definitions	definitions/items/armory/samurai	definitions/items/weaponry/samurai scripts scripts/potions	scripts/skills scripts/wolfpack</H1>
    <B>naddel at BerliOS</B> 
    <A HREF="mailto:wolfpack-svn%40lists.berlios.de?Subject=Re%3A%20%5BWolfpack-svn%5D%20r6841%20-%20in%20trunk/server/release%3A%20definitions%0A%09definitions/items/armory/samurai%0A%09definitions/items/weaponry/samurai%20scripts%20scripts/potions%0A%09scripts/skills%20scripts/wolfpack&In-Reply-To=%3C200706251334.l5PDYx2W028280%40sheep.berlios.de%3E"
       TITLE="[Wolfpack-svn] r6841 - in trunk/server/release: definitions	definitions/items/armory/samurai	definitions/items/weaponry/samurai scripts scripts/potions	scripts/skills scripts/wolfpack">naddel at mail.berlios.de
       </A><BR>
    <I>Mon Jun 25 15:34:59 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000045.html">[Wolfpack-svn] r6840 - trunk/server/release/scripts/wolfpack
</A></li>
        <LI>Next message: <A HREF="000047.html">[Wolfpack-svn] r6842 - in trunk/WPGM: . Components/Graphics32 UOLib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46">[ date ]</a>
              <a href="thread.html#46">[ thread ]</a>
              <a href="subject.html#46">[ subject ]</a>
              <a href="author.html#46">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: naddel
Date: 2007-06-25 15:34:57 +0200 (Mon, 25 Jun 2007)
New Revision: 6841

Added:
   trunk/server/release/scripts/ninja_belt.py
Modified:
   trunk/server/release/definitions/items/armory/samurai/leather_ninja_belt.xml
   trunk/server/release/definitions/items/weaponry/samurai/shuriken.xml
   trunk/server/release/definitions/scripts.xml
   trunk/server/release/scripts/potions/utilities.py
   trunk/server/release/scripts/shuriken.py
   trunk/server/release/scripts/skills/poisoning.py
   trunk/server/release/scripts/skills/tracking.py
   trunk/server/release/scripts/wolfpack/utilities.py
Log:
partly rewrote tracking
added ninja belt/shuriken

Modified: trunk/server/release/definitions/items/armory/samurai/leather_ninja_belt.xml
===================================================================
--- trunk/server/release/definitions/items/armory/samurai/leather_ninja_belt.xml	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/definitions/items/armory/samurai/leather_ninja_belt.xml	2007-06-25 13:34:57 UTC (rev 6841)
@@ -18,8 +18,8 @@
 		&lt;smelt&gt;20&lt;/smelt&gt;
 		&lt;weight&gt;10.0&lt;/weight&gt;
 		&lt;type&gt;1009&lt;/type&gt;
-		&lt;basescripts&gt;equipment, shuriken&lt;/basescripts&gt;
-		&lt;category&gt;Base Armor\Samurai\Leather\Nina Belt&lt;/category&gt;
+		&lt;basescripts&gt;equipment,ninja_belt&lt;/basescripts&gt;
+		&lt;category&gt;Base Armor\Samurai\Leather\Ninja Belt&lt;/category&gt;
 		&lt;!-- Properties --&gt;
 		&lt;tag name=&quot;resname&quot; value=&quot;leather&quot; /&gt;
 		&lt;tag name=&quot;remaining_uses&quot; type=&quot;int&quot; value=&quot;0&quot; /&gt;
@@ -29,17 +29,17 @@
 		&lt;intproperty name=&quot;res_cold&quot; value=&quot;3&quot; /&gt;
 		&lt;intproperty name=&quot;res_poison&quot; value=&quot;3&quot; /&gt;
 		&lt;intproperty name=&quot;res_energy&quot; value=&quot;3&quot; /&gt;
-		&lt;bindmenu&gt;shuriken&lt;/bindmenu&gt;
+		&lt;bindmenu&gt;ninja_belt&lt;/bindmenu&gt;
 	&lt;/item&gt;
 
 	&lt;item id=&quot;27db&quot; inherit=&quot;2790&quot;&gt;
 		&lt;id&gt;0x27db&lt;/id&gt;
 		&lt;baseid&gt;2790&lt;/baseid&gt;
-		&lt;category&gt;Base Armor\Samurai\Leather\Nina Belt 2&lt;/category&gt;
+		&lt;category&gt;Base Armor\Samurai\Leather\Ninja Belt 2&lt;/category&gt;
 	&lt;/item&gt;
 
-	&lt;contextmenu id=&quot;shuriken&quot;&gt;
-		&lt;scripts&gt;shuriken&lt;/scripts&gt;
+	&lt;contextmenu id=&quot;ninja_belt&quot;&gt;
+		&lt;scripts&gt;ninja_belt&lt;/scripts&gt;
 		&lt;option tag=&quot;1&quot; msgid=&quot;6222&quot; /&gt; &lt;!-- Load Ninja Belt --&gt;
 		&lt;option tag=&quot;2&quot; msgid=&quot;6223&quot; checkenabled=&quot;true&quot; /&gt; &lt;!-- Unload Ninja Belt --&gt;
 	&lt;/contextmenu&gt;

Modified: trunk/server/release/definitions/items/weaponry/samurai/shuriken.xml
===================================================================
--- trunk/server/release/definitions/items/weaponry/samurai/shuriken.xml	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/definitions/items/weaponry/samurai/shuriken.xml	2007-06-25 13:34:57 UTC (rev 6841)
@@ -8,8 +8,6 @@
  *=======================================================*/
 --&gt;
 &lt;definitions&gt;
-
-	&lt;!-- Unknown --&gt;
 	&lt;!-- Shuriken --&gt;
 	&lt;item id=&quot;27ac&quot;&gt;
 		&lt;id&gt;0x27ac&lt;/id&gt;
@@ -19,18 +17,12 @@
 		&lt;sellprice&gt;120&lt;/sellprice&gt;
 		&lt;buyprice&gt;40&lt;/buyprice&gt;
 		&lt;durability&gt;&lt;random min=&quot;30&quot; max=&quot;60&quot; /&gt;&lt;/durability&gt;
-		&lt;weight&gt;4.0&lt;/weight&gt;
-		&lt;!--&lt;basescripts&gt;equipment,blades&lt;/basescripts&gt;--&gt;
-		&lt;!--&lt;type&gt;1001&lt;/type&gt;--&gt;
+		&lt;weight&gt;1.0&lt;/weight&gt;
+		&lt;basescripts&gt;shuriken&lt;/basescripts&gt;
 		&lt;category&gt;Base Weapons\Samurai\Unknown\Shuriken 1&lt;/category&gt;
 		&lt;!-- Properties --&gt;
+		&lt;tag name=&quot;remaining_uses&quot; type=&quot;int&quot; value=&quot;1&quot; /&gt;
 		&lt;tag name=&quot;resname&quot; value=&quot;iron&quot; /&gt;
-		&lt;!--
-		&lt;intproperty name=&quot;req_strength&quot; value=&quot;35&quot; /&gt;
-		&lt;intproperty name=&quot;speed&quot; value=&quot;37&quot; /&gt;
-		&lt;intproperty name=&quot;mindamage&quot; value=&quot;14&quot; /&gt;
-		&lt;intproperty name=&quot;maxdamage&quot; value=&quot;16&quot; /&gt;
-		--&gt;
 	&lt;/item&gt;
 
 	&lt;item id=&quot;27f7&quot; inherit=&quot;27ac&quot;&gt;
@@ -38,5 +30,4 @@
 		&lt;baseid&gt;27ac&lt;/baseid&gt;
 		&lt;category&gt;Base Weapons\Samurai\Unknown\Shuriken 2&lt;/category&gt;
 	&lt;/item&gt;
-
 &lt;/definitions&gt;

Modified: trunk/server/release/definitions/scripts.xml
===================================================================
--- trunk/server/release/definitions/scripts.xml	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/definitions/scripts.xml	2007-06-25 13:34:57 UTC (rev 6841)
@@ -66,6 +66,7 @@
 	&lt;script&gt;lockpick&lt;/script&gt;
 	&lt;script&gt;map&lt;/script&gt;
 	&lt;script&gt;moongate&lt;/script&gt;
+	&lt;script&gt;ninja_belt&lt;/script&gt;
 	&lt;script&gt;oil_cloth&lt;/script&gt;
 	&lt;script&gt;ore&lt;/script&gt;
 	&lt;script&gt;pickaxe&lt;/script&gt;
@@ -187,6 +188,7 @@
 	&lt;script&gt;commands.sysmessage&lt;/script&gt;
 	&lt;script&gt;commands.tags&lt;/script&gt;
 	&lt;script&gt;commands.tele&lt;/script&gt;
+	&lt;script&gt;commands.test&lt;/script&gt;
 	&lt;script&gt;commands.testapi&lt;/script&gt;
 	&lt;script&gt;commands.testlos&lt;/script&gt;
 	&lt;script&gt;commands.tile&lt;/script&gt;

Added: trunk/server/release/scripts/ninja_belt.py
===================================================================
--- trunk/server/release/scripts/ninja_belt.py	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/scripts/ninja_belt.py	2007-06-25 13:34:57 UTC (rev 6841)
@@ -0,0 +1,257 @@
+#################################################################
+#   )      (\_     # WOLFPACK 13.0.0 Scripts                    #
+#  ((    _/{  &quot;-;  # Created by: Naddel                         #
+#   )).-' {{ ;'`   # Revised by:                                #
+#  ( (  ;._ \\ ctr # Last Modification: Created                 #
+#################################################################
+
+import wolfpack
+from wolfpack.utilities import hasHandFree
+import random
+from wolfpack.consts import NINJITSU
+from system.poison import POISONS, poison
+
+maxUses = 10
+
+
+def onUse(char, item):
+	if not item.layer &gt; 0:
+		return
+	if item.hastag('remaining_uses') and item.gettag('remaining_uses') &lt; 1:
+		char.socket.clilocmessage( 1063297 ) # You have no shuriken in your ninja belt!
+	elif item.hastag('using'):
+		char.socket.clilocmessage( 1063298 ) # You cannot throw another shuriken yet.
+	elif not hasHandFree(char, item):
+		char.socket.clilocmessage( 1063299 ) # You must have a free hand to throw shuriken.
+	else:
+		char.socket.attachtarget( 'ninja_belt.callback', [item.serial] )
+	return True
+
+def callback(player, arguments, target):
+	belt = wolfpack.finditem(arguments[0])
+	if not belt or belt.layer == 0:
+		return
+	
+	if target.char:
+		Shoot(player, belt, target.char)
+	elif target.item and target.item.hasscript('shuriken'):
+		Reload( player, belt, target.item )
+	else:
+		player.socket.clilocmessage( 1063301 ) # You can only place shuriken in a ninja belt.
+
+# Shoot on a target char
+def Shoot(player, belt, target):
+	if player == target:
+		return
+	if target.invulnerable or target.gm:
+		return
+	elif belt.hastag('remaining_uses') and belt.gettag('remaining_uses') &lt; 1:
+		player.socket.clilocmessage( 1063297 ) # You have no shuriken in your ninja belt!
+	elif belt.hastag('using'):
+		player.socket.clilocmessage( 1063298 ) # You cannot throw another shuriken yet.
+	elif not hasHandFree(player, belt):
+		player.socket.clilocmessage( 1063299 ) # You must have a free hand to throw shuriken.
+	elif not player.distanceto(target) &gt; 2:
+		player.socket.clilocmessage( 1063303 ) # Your target is too close!
+	else:
+		belt.settag('using', 1)
+		player.turnto(target)
+		player.reveal()
+		player.action(9) # 26 if mounted!
+		player.soundeffect(0x23A)
+
+		player.movingeffect(0x27AC, target, False, False, 1)
+
+		if player.checkskill(NINJITSU, -100, 650):
+			target.addtimer(1000, onShurikenHit, [player.serial, belt.serial])
+		else:
+			ConsumeUse(belt)
+
+		belt.addtimer(2500, ResetUsing, [])
+
+# Handle hit
+def onShurikenHit(target, args):
+	player = wolfpack.findchar(args[0])
+	belt = wolfpack.finditem(args[1])
+	if not player or not belt:
+		return
+
+	target.damage(0, random.randint(3, 5), player)
+
+	poison_lvl = -1
+	poisoning_uses = 0
+	if belt.hastag('poisoning_strength'):
+		poison_lvl = belt.gettag('poisoning_strength')
+	if belt.hastag('poisoning_uses'):
+		poisoning_uses = belt.gettag('poisoning_uses')
+
+	if poison_lvl != -1 and poisoning_uses &gt; 0:
+		poison(target, poison_lvl)
+
+	ConsumeUse(belt)
+
+# Belt can be used again
+def ResetUsing(belt, args):
+	belt.deltag('using')
+
+# Consume a shuriken from the belt
+def ConsumeUse(belt):
+	remaining_uses = 0
+	if belt.hastag('remaining_uses'):
+		remaining_uses = belt.gettag('remaining_uses')
+	if remaining_uses &lt; 1:
+		return
+
+	belt.settag('remaining_uses', remaining_uses - 1)
+
+	# Consume poison charges
+	if belt.hastag('poisoning_uses') and belt.gettag('poisoning_uses') &gt; 0:
+		belt.settag('poisoning_uses', belt.gettag('poisoning_uses') - 1)
+		if belt.gettag('poisoning_uses') == 0:
+			belt.settag('poisoning_strength', -1)
+
+	belt.resendtooltip()
+
+# Unload the belt
+def Unload(player, belt):
+	belt_rem_uses = 0
+	belt_poison = -1
+	belt_pC = 0
+
+	if belt.hastag('poisoning_strength'):
+		belt_poison = belt.gettag('poisoning_strength')
+	if belt.hastag('poisoning_uses'):
+		belt_pC = belt.gettag('poisoning_uses')
+
+	if belt.hastag('remaining_uses'):
+		belt_rem_uses = belt.gettag('remaining_uses')
+
+	if belt_rem_uses &lt; 1:
+		return
+
+	backpack = player.getbackpack()
+	shuriken = wolfpack.additem('27ac')
+	shuriken.settag('poisoning_strength', belt_poison )
+	shuriken.settag('poisoning_uses', belt_pC )
+	shuriken.amount = belt_rem_uses
+	shuriken.settag('remaining_uses', belt_rem_uses)
+	backpack.additem( shuriken )
+	shuriken.update()
+
+	belt.settag('remaining_uses', 0)
+	belt.settag('poisoning_uses', 0)
+	belt.settag('poisoning_strength', -1)
+
+	belt.resendtooltip()
+
+
+# Reload over ContextMenu
+def TargetReload(player, arguments, target):
+	belt = wolfpack.finditem(arguments[0])
+	if not belt:
+		return
+
+	if target.item and target.item.hasscript('shuriken'):
+		Reload( player, belt, target.item )
+
+# Reload the belt
+def Reload(player, belt, shuriken):
+	belt_rem_uses = shuriken_rem_uses = 0
+
+	shuriken_poison = belt_poison = -1
+	shuriken_poisonUses = belt_poisonUses = 0
+
+	if belt.hastag('remaining_uses'):
+		belt_rem_uses = belt.gettag('remaining_uses')
+
+	if shuriken.hastag('remaining_uses'):
+		shuriken_rem_uses = shuriken.gettag('remaining_uses')
+
+	need = maxUses - belt_rem_uses
+
+	if need &lt;= 0:
+		player.socket.clilocmessage( 1063302 ) # You cannot add any more shuriken.
+	elif shuriken_rem_uses &gt; 0:
+		if need &gt; shuriken_rem_uses:
+			need = shuriken_rem_uses
+
+		if shuriken.hastag('poisoning_strength'):
+			shuriken_poison = shuriken.gettag('poisoning_strength')
+		if shuriken.hastag('poisoning_uses'):
+			shuriken_poisonUses = shuriken.gettag('poisoning_uses')
+		if belt.hastag('poisoning_uses'):
+			belt_poisonUses = belt.gettag('poisoning_uses')
+
+		if shuriken_poison != -1 and shuriken_poisonUses &gt; 0:
+			if belt_poisonUses &lt;= 0 or belt_poison == shuriken_poison:
+				if belt_poisonUses != 0 and belt_poison &lt; shuriken_poison:
+					Unload( player, belt )
+				if need &gt; shuriken_poisonUses:
+					need = shuriken_poisonUses
+
+				if belt_poison == -1 or belt_poisonUses &lt;= 0:
+					belt_poisonUses = need
+				else:
+					belt_poisonUses += need
+
+				belt_poison = shuriken_poison
+
+				shuriken_poisonUses -= need;
+
+				if shuriken_poisonUses &lt;= 0:
+					shuriken_poison = -1
+				
+				belt.settag('poisoning_strength', belt_poison)
+				belt.settag('poisoning_uses', belt_poisonUses)
+				
+				shuriken.settag('poisoning_strength', shuriken_poison)
+				shuriken.settag('poisoning_uses', shuriken_poisonUses)
+
+				belt.settag('remaining_uses', belt_rem_uses + need)
+				shuriken.settag('remaining_uses', shuriken_rem_uses - need)
+
+			else:
+				player.socket.clilocmessage( 1070767 ) # Loaded projectile is stronger, unload it first
+		else:
+			belt.settag('remaining_uses', belt_rem_uses + need)
+			shuriken.settag('remaining_uses', shuriken_rem_uses - need)
+
+		if shuriken.gettag('remaining_uses') &lt;= 0:
+			shuriken.delete()
+
+		shuriken.resendtooltip()
+		belt.resendtooltip()
+
+######################################################################################
+#############   Tool Tip   ###########################################################
+######################################################################################
+
+def onShowTooltip(viewer, object, tooltip):
+	tooltip.add(1060584, str(object.gettag('remaining_uses')))
+
+	belt_poison = -1
+	belt_poisonUses = 0
+	if object.hastag('poisoning_strength'):
+		belt_poison = object.gettag('poisoning_strength')
+	if object.hastag('poisoning_uses'):
+		belt_poisonUses = object.gettag('poisoning_uses')
+		
+	if belt_poison != -1 and belt_poisonUses &gt; 0:
+		tooltip.add( 1062412 + belt_poison, str(belt_poisonUses) )
+
+######################################################################################
+#############   Context Menu   #######################################################
+######################################################################################
+
+def onContextCheckEnabled(player, object, tag):
+	return object.gettag('remaining_uses') &gt; 0
+
+def onContextEntry(player, object, entry):
+	if entry == 1:
+		player.socket.attachtarget( 'ninja_belt.TargetReload', [object.serial] )
+	elif entry == 2:
+		Unload( player, object )
+
+def onEquip(char, item, layer):
+	if char.socket:
+		char.socket.clilocmessage( 1070785 ) # Double click this item each time you wish to throw a shuriken.

Modified: trunk/server/release/scripts/potions/utilities.py
===================================================================
--- trunk/server/release/scripts/potions/utilities.py	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/scripts/potions/utilities.py	2007-06-25 13:34:57 UTC (rev 6841)
@@ -2,7 +2,7 @@
 import wolfpack
 import time
 from random import randint, random
-from wolfpack.utilities import hex2dec, throwobject, energydamage, checkLoS
+from wolfpack.utilities import hex2dec, throwobject, energydamage, checkLoS, hasHandFree
 from potions.consts import *
 from wolfpack.consts import *
 from wolfpack import properties
@@ -25,22 +25,12 @@
 # You have to have one hand free for using a potion
 # This is not valid for explosion potions
 def canUsePotion( char, item ):
-	firsthand = char.itemonlayer( 1 )
-	secondhand = char.itemonlayer( 2 )
+	if not hasHandFree(char, item):	
+		# You must have a free hand to drink a potion.
+		char.socket.clilocmessage( 0x7A99C )
+		return False
+	return True
 
-	if not firsthand and not secondhand:
-		return True
-
-	if firsthand and not secondhand and not firsthand.twohanded or properties.fromitem(firsthand, BALANCED):
-		return True
-
-	if not firsthand and secondhand and not secondhand.twohanded or properties.fromitem(secondhand, BALANCED):
-		return True
-
-	# You must have a free hand to drink a potion.
-	char.socket.clilocmessage( 0x7A99C )
-	return False
-
 # Consume the potion
 def consumePotion( char, potion, givebottle=True ):
 	if potion.amount == 1:

Modified: trunk/server/release/scripts/shuriken.py
===================================================================
--- trunk/server/release/scripts/shuriken.py	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/scripts/shuriken.py	2007-06-25 13:34:57 UTC (rev 6841)
@@ -1,78 +1,21 @@
 #################################################################
 #   )      (\_     # WOLFPACK 13.0.0 Scripts                    #
 #  ((    _/{  &quot;-;  # Created by: MagnusBr                       #
-#   )).-' {{ ;'`   # Revised by:                                #
-#  ( (  ;._ \\ ctr # Last Modification: Created                 #
+#   )).-' {{ ;'`   # Revised by: Naddel                         #
+#  ( (  ;._ \\ ctr # Last Modification: Modified                #
 #################################################################
 
-####################################################################################
-###################     Imports      ###############################################
-####################################################################################
-
 import wolfpack
 
-######################################################################################
-#############   Tool Tip   ###########################################################
-######################################################################################
-
 def onShowTooltip(viewer, object, tooltip):
-
 	tooltip.add(1060584, str(object.gettag('remaining_uses')))
 
-######################################################################################
-#############   Context Menu   #######################################################
-######################################################################################
-
-def onContextCheckEnabled(player, object, tag):
-
-	ruses = object.gettag('remaining_uses')
-
-	if ruses &gt; 0:
-		return True
-	else:
-		return False
-
-def onContextEntry(player, object, entry):
-	if entry == 1:
-		player.socket.sysmessage( &quot;Select a Shuriken to load on Ninja Belt&quot; )
-		player.socket.attachtarget( &quot;shuriken.targetload&quot;, [object.serial] )
-	elif entry == 2:
-		fillshurikens( player, object )
-
-######################################################################################
-#############   Fill Shurikens   #####################################################
-######################################################################################
-
-def fillshurikens( player, object ):
-	
-	backpack = player.getbackpack()
-	ruses = object.gettag('remaining_uses')
-
-	for i in range(1, ruses):
-		shuriken = wolfpack.additem('27ac')
-		backpack.additem( shuriken )
-
-	object.settag('remaining_uses', 0)
-	object.resendtooltip()
-
-######################################################################################
-#############   Target for Load   ####################################################
-######################################################################################
-
-def targetload( char, args, target ):
-
-	object = wolfpack.finditem( args[0] )
-	
-	if not target:
-		return False
-	
-	if target.item.id == 0x27ac:
-		if target.item.container == char.getbackpack():
-			ruses = object.gettag('remaining_uses')
-			object.settag('remaining_uses', ruses + 1)
-			target.item.delete()
-			object.resendtooltip()
-		else:
-			char.socket.sysmessage( &quot;Shuriken have to be in your backpack&quot; )
-	else:
-		char.socket.clilocmessage( 1063301 )
\ No newline at end of file
+	poison = -1
+	poisonUses = 0
+	if object.hastag('poisoning_strength'):
+		poison = object.gettag('poisoning_strength')
+	if object.hastag('poisoning_uses'):
+		poisonUses = object.gettag('poisoning_uses')
+		
+	if poison != -1 and poisonUses &gt; 0:
+		tooltip.add( 1062412 + poison, str(poisonUses) )

Modified: trunk/server/release/scripts/skills/poisoning.py
===================================================================
--- trunk/server/release/scripts/skills/poisoning.py	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/scripts/skills/poisoning.py	2007-06-25 13:34:57 UTC (rev 6841)
@@ -48,7 +48,7 @@
 	return 1
 
 # Check for the following weapons: Butchers Knife, Cleaver, Dagger, Double Bladed Staff, Pike, Kryss
-ALLOWED = [ 0x13f6, 0x13f7, 0xec2, 0xec3, 0xf51, 0xf52, 0x26bf, 0x26c9, 0x26be, 0x26c8, 0x1400, 0x1401 ]
+ALLOWED = [ 0x13f6, 0x13f7, 0xec2, 0xec3, 0xf51, 0xf52, 0x26bf, 0x26c9, 0x26be, 0x26c8, 0x1400, 0x1401, 0x27ac ]
 
 def selecttarget( char, args, target ):
 	# you cannot use skill while dead
@@ -111,10 +111,16 @@
 	item.settag( 'poisoning_char', char.serial )
 	item.settag( 'poisoning_strength', strength )
 	item.settag( 'poisoning_skill', skill )
+	
+	uses_remaining = 0
+	if item.hastag('remaining_uses'):
+		uses_remaining = item.gettag('remaining_uses')
 	# weapon : poison chance when hit % = char.skill[ POISONING ] / 4
 	# 	number of uses before the poison wears off
 	if item.hasscript( 'blades' ):
 		item.settag( 'poisoning_uses', 18 - strength * 2 )
+	elif item.hasscript( 'shuriken' ):
+		item.settag( 'poisoning_uses', min( 18 - strength * 2, uses_remaining) )
 	item.resendtooltip()
 	return 1
 

Modified: trunk/server/release/scripts/skills/tracking.py
===================================================================
--- trunk/server/release/scripts/skills/tracking.py	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/scripts/skills/tracking.py	2007-06-25 13:34:57 UTC (rev 6841)
@@ -19,23 +19,7 @@
 
 elves_tracking_chance = int( wolfpack.settings.getnumber(&quot;Racial Features&quot;, &quot;Elves evade tracking chance&quot;, 50, True) )
 
-#cliloc
-#502989 tracking failed
-#502990 This area is too crowded to track any individual animal.
-#502991 You see no evidence of animals in the area.
-#502992 This area is too crowded to track any individual creature.
-#502993 You see no evidence of creatures in the area.
-#502994 This area is too crowded to track any individual.
-#502995 You see no evidence of people in the area.
-#1011350 What do you wish to track?
-#1018086 What do you wish to track?
-#1018093 Select the one you would like to track.
-#1002165 tracking
-#1002166 The tracking skill will allow you to track animals, monsters, and people. Use the skill by clicking the jewel on your skill list. You will be presented with a window, which will allow you to choose what you wish to track. Double-click the category you wish to track (animal, human, or monster), and you will be presented with a second window listing the specific PCs or NPC's that you can track. If you are successful, and an appropriate creature can be tracked, you will be told in what direction that creature can be found. The higher your skill level
-#1005645 I did not find a nearby track piece
-
 # Some comments from stratics to implement some time:
-# Necromancers can be a bit harder or easier depending on which form they aren in.
 # Vampires always have a minimum of 50, if their Hiding + Stealth is less than 50. 
 # The big blue four-armed demon gets a penalty of 20. It's so big it's easier to track. 
 # Wraiths and Banshees get a bonus of 20 to their difficulty, if they're below 200. 
@@ -57,6 +41,9 @@
    
 	socket.clilocmessage( 1011350 ) # What do you wish to track?
 	socket.closegump( 0x87651592 ) # What to track
+	TrackWhatGump( char )
+
+def TrackWhatGump( char ):
 	gump = cGump( x=20, y=30, callback=trackWhatResponse, type=0x87651592 )
 
 	gump.startPage( 0 )
@@ -82,7 +69,7 @@
 
 	gump.send( char )
 
-	socket.settag( 'skill_delay', int( wolfpack.time.currenttime() + TRACKING_DELAY ) )
+	char.socket.settag( 'skill_delay', int( wolfpack.time.currenttime() + TRACKING_DELAY ) )
 
 	if skills.skilltable[ TRACKING ][ skills.UNHIDE ] and char.hidden:
 		char.reveal()
@@ -108,155 +95,156 @@
 	elif val==8:
 		return tr(&quot;is here&quot;)
 
-def trackWhatResponse( char, args, target ):
-	# what the range, hypothesis : skill 100%==radius 50==the small map ingame
-	rayon= char.skill[ TRACKING ]*50/1000
-	button=target.button
+def CheckDifficulty( char, target ):
+	tracking = char.skill[TRACKING]
+	detectHidden = char.skill[DETECTINGHIDDEN]
+
+	if target.elf:
+		tracking /= 2
+
+	hiding = target.skill[HIDING]
+	stealth = target.skill[STEALTH]
+	divisor = hiding + stealth
+
+	# Necromancy forms affect tracking difficulty 
+	if target.hasscript(&quot;magic.horrificbeast&quot;):
+		divisor -= 200
+	elif target.hasscript(&quot;magic.vampiricembrace&quot;) and divisor &lt; 500:
+		divisor = 500
+	elif target.hasscript(&quot;magic.wraithform&quot;) and divisor &lt;= 2000:
+		divisor += 200
+
+	chance = 0
+	if divisor &gt; 0:
+		#if ( Core.SE )
+		chance = 50 * (tracking * 2 + detectHidden) / divisor
+		#else
+			#chance = 50 * (tracking + detectHidden + 10 * Utility.RandomMinMax( 1, 20 )) / divisor;
+	else:
+		chance = 100
+
+	return chance &gt; random.randint( 1, 100 )
+
+
+def trackWhatResponse( char, args, response ):
+	success = char.checkskill( TRACKING, 0, 211 )
+	if not success:
+		char.socket.clilocmessage( 1018092 ) # You see no evidence of those in the area.
+		return
+	
+	char.checkskill( TRACKING, 211, 1000 ) # Passive gain
+
+	ran= 10 + ( char.skill[ TRACKING ] / 10 )
+	
+	button = response.button
+	
 	liste=[]
-	#look around characters (not really a circle but nervermind)
-	iterator = wolfpack.charregion(char.pos.x -rayon,char.pos.y-rayon,char.pos.x +rayon,char.pos.y+rayon,char.pos.map)
-	# filter the list with the player's choice
-	charcible = iterator.first
-	while charcible:
-		# NEVER track invisible staff members
-		if not charcible.invisible and not charcible.dead:
-			if target.button == 4 : #have to exit non-players and exit self
+	for charcible in wolfpack.chars(char.pos.x, char.pos.y, char.pos.map, ran):
+		if not charcible.invisible and not charcible.dead and CheckDifficulty(char, charcible):
+			# Track players
+			if button == 4:
 				if charcible.player and not charcible == char:
-					# Tracking Chances
-					if ( charcible.skill[HIDING] + charcible.skill[STEALTH] ) &gt; 0:
-						chance = int( ( char.skill[TRACKING] + char.skill[DETECTINGHIDDEN] + random.randint(10,200) ) / ( charcible.skill[HIDING] + charcible.skill[STEALTH] ) * 50 )
-					else:
-						chance = 100
-	
-					if charcible.elf:
-						chance -= ( chance * elves_tracking_chance ) / 100
-					
-					if random.randint(1,100) &lt; chance:
-						liste.append(charcible)
+					liste.append(charcible)
 
-			if target.button == 3 : #have to exit non-PNJ humans
-				if charcible.bodytype==4 and charcible.npc:
+			elif charcible.npc:
+				# Track humans
+				if button == 3 and charcible.bodytype == 4:
 					liste.append(charcible)
-			if target.button == 2 : #have to exit non-Monsters
-				if charcible.bodytype==1 and charcible.npc:
+				# Track monsters
+				elif button == 2 and charcible.bodytype == 1:
 					liste.append(charcible)
-			if target.button == 1 : #have to exit non-animals
-				if charcible.bodytype==3 and charcible.npc:
+				# Track animals
+				elif button == 1 and charcible.bodytype == 3:
 					liste.append(charcible)
-				
-		charcible = iterator.next
-	#Answer to the player
-	if liste==[]: #nothing to find
-		if target.button == 4 or target.button == 3:
+
+		#charcible = iterator.next
+
+	if len(liste) == 0:
+		if target.button in [3, 4]:
 			char.socket.clilocmessage( 502995, '', GRAY ) # You see no evidence of people in the area.
 		elif target.button == 1:
 			char.socket.clilocmessage( 502991, '', GRAY ) # You see no evidence of animals in the area.
 		else:
 			char.socket.clilocmessage( 502993, '', GRAY ) # You see no evidence of creatures in the area.
-	else: #list is not empty
+	else:
+		TrackWhoGump(char, liste, 1, ran)
+		char.socket.clilocmessage( 1018093 ) # Select the one you would like to track.
 
-		createsecondmenu(char, liste, 1)
+from math import ceil
+def TrackWhoGump(char, liste, startpoint, ran):
 
-		#for charcible in liste:
-		#	char.socket.sysmessage(&quot;%s %s&quot;%(charcible.name,dircard(char.directionto(charcible))))
-	
-	#check skill
-	success = char.checkskill( TRACKING, 0, 1000 )
-	return True
-
-def createsecondmenu(char, liste, startpoint):
-
 	socket = char.socket
 
-	socket.closegump( 0x87651592 ) # What to track
-	gump = cGump( x=20, y=30, callback=trackWhatResponse2, type=0x87651592 )
+	socket.closegump( 0x87651592 ) # TrackWhatGump/TrackWhoGump
+	gump = cGump( x=20, y=30, callback=trackWhoResponse, type=0x87651592 )
 
 	gump.startPage( 0 )
 	gump.addBackground( 5054, 440, 135 )
 	gump.addResizeGump( 10, 10, 2620, 420, 75 )
 	gump.addResizeGump( 10, 85, 3000, 420, 25 )
 
-	# Last and next buttons
-	if ( len(liste) - startpoint + 1 ) &gt; 4:
-		gump.addButton(415, 115, 5224, 5224, 200)
 
-	if startpoint &gt; 4:
-		gump.addButton(5, 115, 5223, 5223, 201)
+	pages = ceil(len(liste) / 4)
 	
-	# First Char
-	if not len(liste) &lt; startpoint:
-		npc1 = liste[startpoint - 1]
-		bodyinfo = wolfpack.bodyinfo(npc1.id)
-		showid1 = bodyinfo['figurine']	
+	for page in range(1, pages + 1):
+		gump.startPage(page)
+		
+		if page &gt; 1:
+			gump.addPageButton(5, 115, 5223, 5223, page - 1)
+		
+		if page &lt; pages:
+			gump.addPageButton(415, 115, 5224, 5224, page + 1)
+		
+		xoffset = 0
+		for i in range(0, 4):
+			if (page - 1) * 4 + i &gt;= len(liste):
+				break
+			
+			npc = liste[(page - 1) * 4 + i]
+			
+			bodyinfo = wolfpack.bodyinfo(npc.id)
+			showid = bodyinfo['figurine']	
+			
+			gump.addTilePic( 20 + xoffset, 20, showid )
+			gump.addButton( 25 + xoffset, 110, 4005, 4007, npc.serial )
+			gump.addText(24 + xoffset, 90, npc.name, 0)
+			
+			xoffset += 100
 
-		gump.addTilePic( 20, 20, showid1 )
-		gump.addButton( 25, 110, 4005, 4007, startpoint )
-		gump.addText(24, 90, npc1.name, 0)
+	gump.setArgs( [liste, ran] )
 
-	# Second Char
-	if not len(liste) &lt; ( startpoint + 1 ):
-		npc2 = liste[startpoint]
-		bodyinfo = wolfpack.bodyinfo(npc2.id)
-		showid2 = bodyinfo['figurine']
-
-		gump.addTilePic( 120, 20, showid2 )
-		gump.addButton( 125, 110, 4005, 4007, startpoint + 1 )
-		gump.addText(120, 90, npc2.name, 0)
-
-	# Third Char
-	if not len(liste) &lt; ( startpoint + 2 ):
-		npc3 = liste[startpoint + 1]
-		bodyinfo = wolfpack.bodyinfo(npc3.id)
-		showid3 = bodyinfo['figurine']
-
-		gump.addTilePic( 220, 20, showid3 )
-		gump.addButton( 225, 110, 4005, 4007, startpoint + 2 )
-		gump.addText(220, 90, npc3.name, 0)
-
-	# Last Char
-	if not len(liste) &lt; ( startpoint + 3 ):
-		npc4 = liste[startpoint + 2]
-		bodyinfo = wolfpack.bodyinfo(npc4.id)
-		showid4 = bodyinfo['figurine']
-
-		gump.addTilePic( 320, 20, showid4 )
-		gump.addButton( 325, 110, 4005, 4007, startpoint + 3 )
-		gump.addText(320, 90, npc4.name, 0)
-
-	gump.setArgs( [liste, startpoint] )
-
 	gump.send( char )
 
 	if skills.skilltable[ TRACKING ][ skills.UNHIDE ] and char.hidden:
 		char.reveal()
 	return True
 
-def trackWhatResponse2( char, args, target ):
-
-	# Retrieve List and Startpoint
-	list = args[0]
-	startpoint = args[1]
-	
-	# Next and last buttons
-	if target.button == 200:
-		createsecondmenu(char, list, startpoint + 4)
-		return True
-
-	if target.button == 201:
-		createsecondmenu(char, list, startpoint - 4)
-		return True
-
+def trackWhoResponse( char, args, response ):
 	# Button is 0?
-	if target.button == 0:
+	if response.button == 0:
 		return True
-
-	# Lets show the NPC position
-	npc = list[target.button - 1]
-
+		
+	# Retrieve List and npc
+	list = args[0]
+	ran = args[1]
+	npc = wolfpack.findchar(response.button)
 	# Send the Arrow
+	sendQuestArrow(char, npc, ran)
+
+def sendQuestArrow( char, npc, ran ):
 	char.socket.questarrow(True, npc.pos.x, npc.pos.y)
+#	char.addtimer( 1000, TrackTimer, [ npc, ran ] )
 
-	return True
+# We need something to see if the Quest Arrow is activated
+# if it's not (e.g. it was closed by click on it), we need not to resend
+def TrackTimer( char, args ):
+	npc = args[0]
+	ran = args[1]
+	if not npc and char.socket or not npc or not char.pos.map == npc.pos.map or not char.canreach(npc, ran):
+		char.socket.clilocmessage( 503177 ) # You have lost your quarry.
+		char.socket.cancelquestarrow()
+	else:
+		sendQuestArrow( char, npc, ran )
 
 def onLoad():
 	skills.register( TRACKING, tracking ) 

Modified: trunk/server/release/scripts/wolfpack/utilities.py
===================================================================
--- trunk/server/release/scripts/wolfpack/utilities.py	2007-06-24 13:15:14 UTC (rev 6840)
+++ trunk/server/release/scripts/wolfpack/utilities.py	2007-06-25 13:34:57 UTC (rev 6841)
@@ -1033,3 +1033,23 @@
 				socket.sysmessage(unicode(char.name) + ': ' + unicode(text), YELLOW)
 		socket = wolfpack.sockets.next()
 	return
+
+&quot;&quot;&quot;
+	\function wolfpack.utilities.hasHandFree
+	\param char The char you want to check to have a free hand.
+	\param item May be None. Not used so far.
+	\description Checks if a char has a free hand.
+&quot;&quot;&quot;
+def hasHandFree( char, item ):
+	firsthand = char.itemonlayer( 1 )
+	secondhand = char.itemonlayer( 2 )
+
+	if not firsthand and not secondhand:
+		return True
+
+	if firsthand and not secondhand and not firsthand.twohanded or properties.fromitem(firsthand, BALANCED):
+		return True
+
+	if not firsthand and secondhand and not secondhand.twohanded or properties.fromitem(secondhand, BALANCED):
+		return True
+	return False


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000045.html">[Wolfpack-svn] r6840 - trunk/server/release/scripts/wolfpack
</A></li>
	<LI>Next message: <A HREF="000047.html">[Wolfpack-svn] r6842 - in trunk/WPGM: . Components/Graphics32 UOLib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46">[ date ]</a>
              <a href="thread.html#46">[ thread ]</a>
              <a href="subject.html#46">[ subject ]</a>
              <a href="author.html#46">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/wolfpack-svn">More information about the Wolfpack-svn
mailing list</a><br>
</body></html>
